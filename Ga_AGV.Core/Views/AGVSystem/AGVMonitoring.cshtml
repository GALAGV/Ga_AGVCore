@{
    ViewBag.Title = "AGVMonitoring";
    Layout = "~/Views/Shared/_LayoutPage.cshtml";
    ViewBag.PageTitle = "AGV系统";
    ViewBag.PageColumn = "运行监控";
}
<link href="~/Content/AGVMonitoring.css" rel="stylesheet" />
<div>
    <div class="count-panel" style="width:100%;margin:0px auto;">
        <div class="panel panel-default">
            <div class="panel-heading " id="pal-text"><span class="glyphicon glyphicon-tower" aria-hidden="true"></span>&nbsp;AGV监控</div>
            <div class="panel-body">
                     <div class="Control-lefts">
                            <div class="form-group">
                                <select id="combobox_agv" class="selectpicker show-tick form-control" data-live-search="false">
                                    <option value="-1">请选择 AGV</option>
                                    <option value="1">AGV 1</option>
                                    <option value="2">AGV 2</option>
                                    <option value="3">AGV 3</option>
                                    <option value="4">AGV 4</option>
                                    <option value="5">AGV 5</option>
                                    <option value="6">AGV 6</option>
                                </select>
                            </div>
                        <div class="count-panel" style="padding:3px;text-align:center;">
                            <div class="x_title">
                                <h2 style="font-size:18px;margin-top:10px;">基本信息</h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="clearfix">
                                <div style="width:100%;">
                                    <ul class="Control-li clearfix-ul">
                                        <li class="clearfix-li">编号</li>
                                        <li class="clearfix-count" id="agvNum">1号</li>
                                        <li class="clearfix-li">状态</li>
                                        <li class="clearfix-count" id="agvIsRunning">在线</li>
                                    </ul>
                                    <ul class="Control-li clearfix-ul">
                                        <li class="clearfix-li">二维码</li>
                                        <li class="clearfix-count clearfix-width info-width" id="qrcode">1</li>
                                    </ul>
                                    <ul class="Control-li clearfix-ul">
                                        <li class="clearfix-li">PBS</li>
                                        <li class="clearfix-count" id="PBS">区域1</li>
                                        <li class="clearfix-li">云台</li>
                                        <li class="clearfix-count" id="agvHolder">上升</li>
                                    </ul>
                                    <ul class="Control-li clearfix-ul">
                                        <li class="clearfix-li">报警信息</li>
                                        <li class="clearfix-count clearfix-width info-width" id="Message">正常</li>
                                    </ul>
                                    <ul class="Control-li clearfix-ul">
                                        <li class="clearfix-li">当前位置</li>
                                        <li class="clearfix-count" id="agvQR">1</li>
                                        <li class="clearfix-li">当前任务</li>
                                        <li class="clearfix-count" id="Task">运输</li>
                                    </ul>
                                    <ul class="Control-li clearfix-ul">
                                        <li class="clearfix-li">出发地</li>
                                        <li class="clearfix-count" id="taskStartQR">1</li>
                                        <li class="clearfix-li">目的地</li>
                                        <li class="clearfix-count" id="taskEndQR">1</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="Control-right">
                        <canvas id="canvas" style="border:#EDEDED solid 1px">您当前的浏览器版本不支持此功能</canvas>
                    </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

    var Wid = 0; var Hei = 0; var id = 0;
    var ar = new Array();

    $(function () {
        $.ajax({
            url: '/api/AGVSystem/ShowPlace',
            type: "post",
            contentType: 'application/json',
            success: function (data) {
                Wid = data.map_X; Hei = data.map_Y;
                ShowQR(Wid, Hei, data.rows); //ShowAGV(data.rows);
                for (var i = 0; i < data.rows.length; i++) {
                    ar.push(data.rows[i])
                }
                //console.log(ar);
            }
        });

        $("#combobox_agv").bind('change', function () {
            var AgvInfo = setInterval(function () {
                ShowAGV(ar, 6);
            }, 1000);
        })

        function ShowAgvInfo(agvQR) {

            //////横线
            //ctx.lineWidth = (Wid / 100);
            //ctx.strokeStyle = "red";
            //ctx.beginPath();
            //ctx.moveTo(ar[10].qrX * coe, ar[10].qrY * coe);
            //ctx.lineTo(ar[15].qrX * coe, ar[15].qrY * coe);
            //ctx.stroke();
            //////纵线
            //ctx.strokeStyle = "red";
            //ctx.beginPath();
            //ctx.moveTo(ar[15].qrX * coe, ar[15].qrY * coe);
            //ctx.lineTo(ar[42].qrX * coe, ar[42].qrY * coe);
            //ctx.stroke();
        }

        function ShowAGV(ar, agvNum) {
            $.ajax({
                url: '/api/AGVSystem/AGVlocation',
                type: "post",
                data: JSON.stringify({ "agvNum": agvNum }),
                contentType: 'application/json',
                success: function (data) {
                    $("#agvNum").text(data.agvNum);
                    $("#agvIsRunning").text(data.agvIsRunning);
                    $("#qrcode").text(data.qrcode);
                    $("#PBS").text(data.PBS);
                    $("#agvHolder").text(data.agvHolder);
                    $("#Message").text(data.Message);
                    $("#agvQR").text(data.agvQR);
                    $("#Task").text(data.Task);
                    $("#taskStartQR").text(data.taskStartQR);
                    $("#taskEndQR").text(data.taskEndQR);
                    id = data.agvQR;
                    console.log("---------------");
                }
            });
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext("2d");
            var img = new Image();
            img.src = "../Scripts/AGVSystem/agv机器人绿.jpg"
            ShowQR(Wid, Hei, ar);
            ctx.drawImage(img, ar[id].qrX - 25, ar[id].qrY - 25, 50, 50);
        };

        function ShowQR(Wid, Hei, ar) {
            var canvas = document.getElementById('canvas');
            canvas.width = Wid;
            canvas.height = Hei;
            if (canvas.getContext) {
                var ctx = canvas.getContext("2d"),
                    width = canvas.width,
                    height = canvas.height;
                //QR
                for (var i = 0; i < ar.length; i++) {
                    ctx.beginPath();
                    ctx.arc(ar[i].qrX, ar[i].qrY, (Wid / 65), 0, 2 * Math.PI, false);
                    ctx.closePath(); //关闭路径
                    if (ar[i].qrStatus == 1) {
                        ctx.fillStyle = "#D1D1D1";
                    } else {
                        ctx.fillStyle = "red";
                    }
                    ctx.fill();//填充
                    //文字
                    ctx.font = "10pt 微软雅黑"; // 字体大小，样式bold Arial
                    ctx.fillStyle = "#FF7F00";
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(ar[i].qrInfo, ar[i].qrX, ar[i].qrY);
                    //console.log(ar[i].qrInfo);

                }
            }
        }

        //测试用
        //function ShowAGV(ar, agvQR) {
        //    var canvas = document.getElementById('canvas');
        //    var ctx = canvas.getContext("2d");
        //    var img = new Image()
        //    img.src = "../Scripts/AGVSystem/agv机器人绿.jpg"
        //    var i = 0;
        //    var T1 = window.setInterval(agv, 500);
        //    function agv() {
        //        for (i; i < ar.length;) {
        //            //console.log(i);
        //            ShowQR(Wid, Hei, ar);
        //            img.src = "../Scripts/AGVSystem/agv机器人绿.jpg"
        //            //ctx.drawImage(img, ar[i].qrX - 25, ar[i].qrY - 25, 50, 50);
        //            //ctx.drawImage(img, ar[i + 10].qrX - 25, ar[i + 10].qrY - 25, 50, 50);
        //            //ctx.drawImage(img, ar[i + 20].qrX - 25, ar[i + 20].qrY - 25, 50, 50);
        //            //ctx.drawImage(img, ar[i + 30].qrX - 25, ar[i + 30].qrY - 25, 50, 50);
        //            //ctx.drawImage(img, ar[i + 40].qrX - 25, ar[i + 40].qrY - 25, 50, 50);
        //            //ctx.drawImage(img, ar[i + 50].qrX - 25, ar[i + 50].qrY - 25, 50, 50);
        //            break;
        //        } i++;
        //    }
        //};
        //测试用
        //比例尺
        //var select = $("#minbeds");
        //var slider = $("#slider").slider({
        //    min: -5,
        //    max: 5,
        //    range: "min",
        //    slide: function (event, ui) {
        //        var w; var h;
        //        if (ui.value == 0) {
        //            w = Wid * 1; h = Hei * 1; ShowAGV(w, h, ar, 1); coe = 1;
        //        } else if (ui.value == -1) {
        //            w = Wid * 0.8; h = Hei * 0.8; ShowAGV(w, h, ar, 0.8); coe = 0.8;
        //        } else if (ui.value == -2) {
        //            w = Wid * 0.6; h = Hei * 0.6; ShowAGV(w, h, ar, 0.6); coe = 0.6;
        //        } else if (ui.value == -3) {
        //            w = Wid * 0.4; h = Hei * 0.4; ShowAGV(w, h, ar, 0.4); coe = 0.4;
        //        } else if (ui.value == -4) {
        //            w = Wid * 0.2; h = Hei * 0.2; ShowAGV(w, h, ar, 0.2); coe = 0.2;
        //        } else if (ui.value == -5) {
        //            w = Wid * 0.1; h = Hei * 0.1; ShowAGV(w, h, ar, 0.1); coe = 0.1;
        //        } else if (ui.value == 1) {
        //            w = Wid * 1.2; h = Hei * 1.2; ShowAGV(w, h, ar, 1.2); coe = 1.2;
        //        } else if (ui.value == 2) {
        //            w = Wid * 1.4; h = Hei * 1.4; ShowAGV(w, h, ar, 1.4); coe = 1.4;
        //        } else if (ui.value == 3) {
        //            w = Wid * 1.6; h = Hei * 1.6; ShowAGV(w, h, ar, 1.6); coe = 1.6;
        //        } else if (ui.value == 4) {
        //            w = Wid * 1.7; h = Hei * 1.7; ShowAGV(w, h, ar, 1.7); coe = 1.7;
        //        } else if (ui.value == 5) {
        //            w = Wid * 1.8; h = Hei * 1.8; ShowAGV(w, h, ar, 1.8); coe = 1.8;
        //        }
        //    }
        //});
        //比例尺
    })
</script>